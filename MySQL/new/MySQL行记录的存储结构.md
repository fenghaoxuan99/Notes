
### **核心问题**  
**MySQL 一行记录的存储结构是什么？**  
此问题涉及 InnoDB 存储引擎的行格式设计，理解后可解决以下关联问题：  
1. MySQL 的 NULL 值会占用空间吗？  
2. MySQL 如何知道 `varchar(n)` 实际占用的数据大小？  
3. `varchar(n)` 中 `n` 的最大取值是多少？  
4. 行溢出后，MySQL 如何处理？  

---

### **关键知识点梳理**  
#### **一、数据存储位置**  
- **表数据文件**：  
  - 路径通过 `SHOW VARIABLES LIKE 'datadir';` 查看。  
  - 每张表的数据存储在独占表空间文件（`表名.ibd`）中（需开启 `innodb_file_per_table=1`）。  

#### **二、表空间结构**  
表空间由四级结构组成（从大到小）：  
| **层级** | **说明** | **大小/特点** |  
|----------|----------|--------------|  
| **段（Segment）** | 数据段（叶子节点）、索引段（非叶子节点）、回滚段 | 由多个区组成 |  
| **区（Extent）** | 连续分配的物理单元 | 1 MB（连续 64 个页，减少随机 I/O） |  
| **页（Page）** | 数据读写的最小单元 | 默认 16 KB（如数据页、Undo 页等） |  
| **行（Row）** | 单条记录的存储结构 | 按行格式（如 Compact）存储 |  

#### **三、InnoDB 行格式（以 Compact 为例）**  
一条记录分为两部分：  
1. **记录的额外信息**  
   - **变长字段长度列表**：  
     - 逆序存储变长字段（如 `varchar`）的真实数据占用字节数。  
     - 若字段最大长度 ≤ 255 字节，用 1 字节存储；否则用 2 字节。  
   - **NULL 值列表**：  
     - 二进制位逆序标识 NULL 字段（1 表示 NULL，0 表示非 NULL）。  
     - 不足整数字节时高位补 0（如 5 个 NULL 字段需 1 字节）。  
   - **记录头信息**（5 字节）：  
     - 包含 `delete_mask`（删除标记）、`next_record`（下条记录位置指针）、`record_type`（记录类型）等。  

2. **记录的真实数据**  
   - 包含用户定义列 + 三个隐藏列：  
     | **隐藏列** | **说明** | **字节** | **存在条件** |  
     |------------|----------|----------|--------------|  
     | `row_id`   | 行唯一 ID | 6 字节 | 无主键/唯一约束时自动生成 |  
     | `trx_id`   | 事务 ID  | 6 字节 | 必需 |  
     | `roll_pointer` | 回滚指针 | 7 字节 | 必需（用于 MVCC） |  

#### **四、关键问题解答**  
1. **NULL 值是否占用空间？**  
   - NULL 值不存储真实数据，但需在 **NULL 值列表**中占 1 位。  
   - 若所有字段为 `NOT NULL`，可节省 NULL 值列表的 1 字节空间。  

2. **如何知道 `varchar(n)` 实际占用大小？**  
   - 通过 **变长字段长度列表** 中存储的字节数确定。  

3. **`varchar(n)` 的 `n` 最大取值？**  
   - **限制条件**：一行总长度（含变长字段长度列表、NULL 值列表）≤ 65535 字节。  
   - **单字段计算公式**：  
     ```  
     n 最大字节数 = 65535 - 变长字段长度列表占用字节 - NULL 值列表占用字节  
     ```  
     - 示例（单字段、字符集为 `ascii`）：  
       - 变长字段长度占用：2 字节（因 `n > 255`）  
       - NULL 列表占用：1 字节（字段允许 NULL）  
       → `n` 最大字节数 = 65535 - 2 - 1 = **65532**（即 `varchar(65532)`）。  
   - **多字段**：需满足所有字段长度 + 变长字段长度列表 + NULL 值列表 ≤ 65535 字节。  

4. **行溢出处理机制**  
   - 当一页（16 KB）无法存下一条记录时，触发行溢出。  
   - **Compact 格式**：  
     - 真实数据部分存储前 768 字节 + 20 字节溢出页地址指针（指向剩余数据的溢出页）。  
   - **Dynamic/Compressed 格式**：  
     - 真实数据部分仅存储 20 字节溢出页地址指针，全部数据存于溢出页。  

---

### **补充说明**  
- **行格式选择**：  
  MySQL 5.1+ 默认 Compact，5.7+ 默认 Dynamic（基于 Compact 优化）。  
- **行溢出阈值**：  
  单行数据（不含 TEXT/BLOB）接近页大小时可能溢出（如包含大字段）。  

> **参考资料**：  
> - 《MySQL 是怎样运行的》  
> - 《MySQL 技术内幕 InnoDB 存储引擎》  
