
### **拔掉网线后 TCP 连接的存活分析**
#### **核心结论**
拔掉网线仅影响物理层，**不直接改变 TCP 连接状态**（内核中仍为 `ESTABLISHED`）。连接是否存活取决于后续场景：

---

### **场景一：拔线后有数据传输**
1. **服务端行为**  
   - 服务端发送数据报文后未收到 ACK，触发超时重传机制。
   - 重传次数由内核参数 `tcp_retries2` 控制（默认值 15）。
   - 实际超时阈值由 `tcp_retries2` 动态计算：  
     ```math
     \text{timeout} = \min(\text{TCP\_RTO\_min} \times 2^{n-1},  \text{TCP\_RTO\_max})
     ```
     - `TCP_RTO_min` = 200ms（下限）
     - `TCP_RTO_max` = 120s（上限）

2. **连接结果**  
   | 客户端动作                | 结果                                                                 |
   |---------------------------|----------------------------------------------------------------------|
   | 在服务端重传完成前插回网线 | 连接恢复（客户端正常响应 ACK）                                       |
   | 超时后插回网线            | 服务端断开连接 → 客户端发送数据时收到 `RST` → 双方连接终止           |

---

### **场景二：拔线后无数据传输**
**依赖 TCP Keepalive 机制是否开启**：  
```bash
# Linux 内核参数（默认值）
net.ipv4.tcp_keepalive_time = 7200    # 空闲探测间隔（秒）
net.ipv4.tcp_keepalive_intvl = 75     # 探测包间隔（秒）
net.ipv4.tcp_keepalive_probes = 9     # 最大探测次数
```

| Keepalive 状态 | 结果                                                                 |
|----------------|----------------------------------------------------------------------|
| **未开启**     | TCP 连接永久保持（即使物理层断开）                                   |
| **开启**       | 累计探测时间 = `tcp_keepalive_time + tcp_keepalive_intvl × tcp_keepalive_probes` <br> • 超时后连接断开（默认约 2 小时 11 分） <br> • 期间插回网线则连接恢复 |

> 📌 **应用层优化**：  
> 业务程序可自定义保活逻辑（如 HTTP 的 `keepalive_timeout`），实现比 TCP 层更快的连接回收。

---

### **扩展场景对比**
| 故障类型         | 是否发送 FIN | 服务端感知速度               | 连接状态变化               |
|------------------|--------------|------------------------------|----------------------------|
| **拔掉网线**     | ❌           | 依赖 Keepalive 或数据传输    | 不主动变更                 |
| **进程崩溃**     | ✅           | 立即（触发四次挥手）         | 快速断开                   |
| **主机宕机**     | ❌           | 同拔网线（需 Keepalive 探测）| 不主动变更                 |

---

### **关键补充说明**
1. **内核结构**  
   TCP 连接在内核中以 `struct socket` 结构体存在，物理层断开不改变其状态。
   
2. **参数调优建议**  
   - 生产环境建议启用 TCP Keepalive 并调整参数（如缩短探测时间）。
   - 应用层保活机制（如心跳包）可规避内核 Keepalive 的延迟问题。

3. **实验验证**  
   通过 `ss -t` 或 `netstat` 命令观察：拔网线后连接仍显示 `ESTABLISHED`，直至超时或探测失败。