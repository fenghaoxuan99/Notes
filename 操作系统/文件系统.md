
### 文件系统核心概念

#### 文件系统基本组成
- **定义**：操作系统管理持久数据的子系统，将文件存储到磁盘硬件以实现持久化。
- **基本单位**：文件。组织方式不同形成不同文件系统。
- **Linux 特性**：一切皆文件（普通文件、目录、块设备、管道、socket 等）。
- **核心数据结构**：
  - **索引节点（inode）**：记录文件元信息（编号、大小、权限、时间戳、磁盘位置等），唯一标识文件，占用磁盘空间。
  - **目录项（dentry）**：记录文件名、inode 指针及层级关系，由内核维护并缓存于内存（不存磁盘），支持多对一关联（如硬链接）。
- **目录 vs 目录项**：目录是文件（磁盘存储），目录项是内存数据结构。
- **数据存储单元**：
  - 磁盘最小单位：扇区（512B）。
  - 文件系统最小单位：逻辑块（通常 4KB），由多个扇区组成，提高读写效率。

#### 虚拟文件系统（VFS）
- **作用**：为用户层与文件系统层提供统一接口，屏蔽不同文件系统差异。
- **文件系统分类**：
  - 磁盘文件系统（如 Ext4、XFS）。
  - 内存文件系统（如 /proc、/sys）。
  - 网络文件系统（如 NFS、SMB）。
- **挂载机制**：文件系统需挂载到目录（如根目录）后使用。

#### 文件使用流程
```c
fd = open(name, flag);  // 打开文件（路径+文件名）
write(fd, ...);         // 写数据（通过文件描述符 fd）
close(fd);              // 关闭文件
```
- **内核维护**：每个进程的打开文件表包含：
  - 文件指针、打开计数器、磁盘位置、访问权限。

#### 文件存储方式
1. **连续空间存放**
   - **原理**：文件存储在连续物理块中，文件头记录起始块位置和长度。
   - **优点**：读写效率高（一次寻道）。
   - **缺点**：磁盘碎片、文件长度扩展困难。

2. **非连续空间存放**
   - **链表方式**：
     - 隐式链表：文件头存首尾块指针，每块含下一块指针。缺点：无法随机访问，指针占用空间。
     - 显式链接（FAT）：内存中维护文件分配表（FAT）。缺点：大磁盘时内存占用高。
   - **索引方式**：
     - 为文件创建索引块存储数据块指针。
     - 优点：无碎片、支持随机访问；缺点：小文件有索引开销。
     - 大文件解决方案：
       - 链式索引块（多级索引）。
       - 多级索引块（如三级索引）。

#### Unix 文件实现
- **混合策略**（Linux Ext2/3）：
  - 文件头含 13 个指针：
    - 10 个直接数据块指针。
    - 1 个一级索引块指针。
    - 1 个二级索引块指针。
    - 1 个三级索引块指针。
- **优化**：Ext4 改进大文件查询效率。

#### 空闲空间管理
1. **空闲表法**：连续空闲区记录起始块和长度。缺点：碎片多时效率低。
2. **空闲链表法**：空闲块通过指针链接。缺点：随机访问差。
3. **位图法**：二进制位表示块使用状态（0 空闲，1 占用）。Linux 用于数据块和 inode 管理。

#### 文件系统结构（Ext2）
- **块组组成**：
  - 超级块：文件系统全局信息（块数量、大小等）。
  - 块组描述符：块组状态信息。
  - 数据位图与 inode 位图。
  - inode 列表：块组内所有 inode。
  - 数据块：文件实际数据。
- **冗余设计**：超级块和块组描述符在多个块组备份，增强容错。

#### 目录存储
- **本质**：特殊文件（含 inode），数据块存储目录项列表（文件名 + inode）。
- **优化**：哈希表加速文件名查找（如 Ext 系统）。

#### 软链接 vs 硬链接
| **类型** | **原理**                     | **跨文件系统** | **源文件删除**       |
|----------|------------------------------|----------------|----------------------|
| 硬链接   | 多个目录项指向同一 inode     | 不支持         | 仅减少链接计数      |
| 软链接   | 独立文件存储目标文件路径     | 支持           | 链接文件仍存在（失效） |

#### 文件 I/O 分类
1. **缓冲 vs 非缓冲 I/O**：
   - 缓冲 I/O：利用标准库缓存加速访问。
   - 非缓冲 I/O：直接系统调用（无库缓存）。

2. **直接 vs 非直接 I/O**：
   - 直接 I/O：跳过内核页缓存（`O_DIRECT` 标志）。
   - 非直接 I/O：经内核缓存（默认）。

3. **阻塞 vs 非阻塞 I/O**：
   - **阻塞 I/O**：等待“数据就绪”和“内核到用户拷贝”完成。
   - **非阻塞 I/O**：轮询数据就绪状态，就绪后同步拷贝数据。
   - **I/O 多路复用**（select/poll）：单线程处理多 I/O 事件，就绪后同步拷贝。

4. **同步 vs 异步 I/O**：
   - **同步 I/O**：阻塞/非阻塞 I/O、I/O 多路复用均需等待**数据拷贝完成**。
   - **异步 I/O**：内核完成数据准备和拷贝后通知应用（无等待）。

